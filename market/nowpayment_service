class NowPaymentsService:
    def __init__(self):
        self.api_key = settings.NOWPAYMENTS_API_KEY
        self.api_url = settings.NOWPAYMENTS_API_URL
        self.ipn_secret = settings.NOWPAYMENTS_IPN_SECRET
        
        if not self.api_key:
            raise ValueError("NOWPAYMENTS_API_KEY not found in environment variables")
        
        self.headers = {
            'x-api-key': self.api_key,
            'Content-Type': 'application/json'
        }

    def get_available_currencies(self):
        try:
            url = f"{self.api_url}/currencies"
            response = requests.get(url, headers=self.headers)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            logger.error(f"Error getting currencies: {str(e)}")
            return {'currencies': ['btc', 'eth', 'usdt', 'ltc', 'trx']}

    def get_minimum_payment_amount(self, currency_from, currency_to='usd'):
        try:
            url = f"{self.api_url}/min-amount"
            params = {
                'currency_from': currency_from,
                'currency_to': currency_to
            }
            response = requests.get(url, headers=self.headers, params=params)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            logger.error(f"Error getting min amount: {str(e)}")
            return {'min_amount': 5}

    def create_payment(self, price_amount, price_currency, pay_currency, order_id, ipn_callback_url):
        try:
            url = f"{self.api_url}/payment"
            data = {
                'price_amount': float(price_amount),
                'price_currency': price_currency,
                'pay_currency': pay_currency,
                'order_id': str(order_id),
                'ipn_callback_url': ipn_callback_url,
            }
            
            logger.info(f"Creating NowPayments payment: {data}")
            response = requests.post(url, headers=self.headers, json=data)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            logger.error(f"Error creating payment: {str(e)}")
            raise

    def create_payout(self, address, amount, currency, ipn_callback_url=None):
        try:
            url = f"{self.api_url}/payout"
            data = {
                'withdrawals': [{
                    'address': address,
                    'currency': currency,
                    'amount': float(amount),
                    'ipn_callback_url': ipn_callback_url
                }]
            }
            
            logger.info(f"Creating NowPayments payout: {data}")
            response = requests.post(url, headers=self.headers, json=data)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            logger.error(f"Error creating payout: {str(e)}")
            raise

    def get_payment_status(self, payment_id):
        try:
            url = f"{self.api_url}/payment/{payment_id}"
            response = requests.get(url, headers=self.headers)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            logger.error(f"Error getting payment status: {str(e)}")
            raise

    def verify_ipn(self, request_data, signature):
        if not self.ipn_secret:
            raise ValueError("NOWPAYMENTS_IPN_SECRET not found")
        
        sorted_data = json.dumps(request_data, sort_keys=True, separators=(',', ':'))
        expected_signature = hmac.new(
            self.ipn_secret.encode('utf-8'),
            sorted_data.encode('utf-8'),
            hashlib.sha512
        ).hexdigest()
        
        return hmac.compare_digest(expected_signature, signature)
