{% load math_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ market.title|default:"Event Trading" }} - EVGxchain</title>
    {% load static %}
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(45, 45, 45, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 5px 0; 
        }
        
        .logo img {
            height: 100px;
            width: auto;
            transition: transform 0.3s ease;
        }
        
        .logo:hover img {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-links a {
            color: #ccc;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #f7931a;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 12px;
            transition: background 0.3s ease;
            position: relative;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f7931a 0%, #ffb84d 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(45, 45, 45, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            padding: 12px 20px;
            color: #ccc;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f7931a;
        }

        /* ========================================
           PRICE TARGET MARKET STYLES
        ======================================== */
        .target-market-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .target-header {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.1), rgba(255, 184, 77, 0.1));
            border: 2px solid rgba(247, 147, 26, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .target-badge {
            display: inline-block;
            background: rgba(247, 147, 26, 0.2);
            border: 1px solid #f7931a;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
            font-weight: 600;
            color: #f7931a;
            margin-bottom: 15px;
        }

        .target-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 20px;
            line-height: 1.3;
        }

        .target-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .target-stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .target-stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .target-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: white;
        }

        .target-stat-value.highlight {
            color: #f7931a;
        }

        .target-progress-section {
            background: rgba(20, 20, 20, 0.9);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 20px;
            font-weight: 600;
        }

        .countdown-timer {
            background: rgba(247, 147, 26, 0.2);
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #f7931a;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            height: 40px;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #f7931a, #ffb84d);
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            font-weight: 600;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            color: #999;
            font-size: 14px;
        }

        .betting-section {
            background: rgba(20, 20, 20, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .betting-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 25px;
        }

        .yes-no-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .yn-option {
            background: rgba(30, 30, 30, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .yn-option.yes {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .yn-option.yes:hover, .yn-option.yes.selected {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
            transform: translateY(-3px);
        }

        .yn-option.no {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .yn-option.no:hover, .yn-option.no.selected {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
            transform: translateY(-3px);
        }

        .yn-label {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .yn-option.yes .yn-label {
            color: #22c55e;
        }

        .yn-option.no .yn-label {
            color: #ef4444;
        }

        .yn-odds {
            font-size: 24px;
            font-weight: 600;
            color: #f7931a;
            margin-bottom: 10px;
        }

        .yn-pool-info {
            font-size: 14px;
            color: #999;
        }

        .bet-amount-section {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .balance-display {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #999;
        }

        .balance-amount {
            color: #f7931a;
            font-size: 20px;
            font-weight: 600;
        }

        .bet-input {
            width: 100%;
            background: rgba(45, 45, 45, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 18px;
            color: white;
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
        }

        .bet-input:focus {
            outline: none;
            border-color: #f7931a;
        }

        .bet-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .preset-btn {
            background: rgba(45, 45, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #999;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover, .preset-btn.active {
            border-color: #f7931a;
            color: #f7931a;
            background: rgba(247, 147, 26, 0.1);
        }

        .place-bet-btn {
            width: 100%;
            background: linear-gradient(135deg, #f7931a 0%, #ffb84d 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .place-bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(247, 147, 26, 0.4);
        }

        .place-bet-btn:disabled {
            background: rgba(60, 60, 60, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .market-description {
            background: rgba(20, 20, 20, 0.9);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .description-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f7931a;
        }

        .description-content {
            color: #ccc;
            line-height: 1.6;
            white-space: pre-line;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        /* ========================================
           EVENT MARKET STYLES (EXISTING)
        ======================================== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .event-header {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .event-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .event-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f7931a 0%, #ffb84d 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .event-name {
            font-size: 28px;
            font-weight: 700;
        }

        .event-pair {
            color: #666;
            font-size: 16px;
        }

        .event-description {
            color: #888;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tf-btn {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #999;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tf-btn:hover, .tf-btn.active {
            background: rgba(247, 147, 26, 0.2);
            border-color: #f7931a;
            color: #f7931a;
        }

        .event-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .trading-chart {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 500px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chart-timer {
            background: rgba(30, 30, 30, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            color: #22c55e;
        }

        .chart-area {
            height: 400px;
            background: rgba(10, 10, 10, 0.5);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            padding: 10px;
        }

        .crypto-chart {
            width: 100% !important;
            height: 100% !important;
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }

        .trading-options {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .options-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .option-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .option-btn {
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .option-btn.up {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .option-btn.up:hover, .option-btn.up.selected {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .option-btn.flat {
            border-color: rgba(249, 115, 22, 0.3);
        }

        .option-btn.flat:hover, .option-btn.flat.selected {
            background: rgba(249, 115, 22, 0.1);
            border-color: #f97316;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.3);
        }

        .option-btn.down {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .option-btn.down:hover, .option-btn.down.selected {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .option-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .option-label.up { color: #22c55e; }
        .option-label.flat { color: #f97316; }
        .option-label.down { color: #ef4444; }

        .option-change {
            font-size: 12px;
            color: #999;
            margin-bottom: 6px;
        }

        .option-stats {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
        }

        .pool-share {
            color: #666;
        }

        .payout {
            color: #f7931a;
            font-weight: 600;
        }

        .bet-section {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .bet-amount-input {
            width: 100%;
            background: rgba(45, 45, 45, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .bet-amount-input:focus {
            outline: none;
            border-color: #f7931a;
        }

        .balance-info {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .yes-no-options {
                grid-template-columns: 1fr;
            }

            .target-stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .target-title {
                font-size: 24px;
            }

            .bet-presets {
                grid-template-columns: repeat(2, 1fr);
            }

            .option-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="{% url 'landing-page' %}" class="logo">
               <img src="/static/evgchain-logo.png" alt="EVGxchain">
            </a>
            <div class="nav-links">
                {% if user.is_authenticated %}
                <a href="{% url 'dashboard' %}">Dashboard</a>
                {% endif %}
            </div>
            <div class="user-profile" onclick="toggleProfileMenu()">
                <div class="user-avatar">
                    {% if user.is_authenticated %}
                        {% if user.full_name %}
                            {{ user.full_name|slice:":2"|upper }}
                        {% else %}
                            {{ user.username|slice:":2"|upper }}
                        {% endif %}
                    {% else %}
                        JD
                    {% endif %}
                </div>
                {% if user.is_authenticated %}
                <div>
                    <div style="font-size: 14px; font-weight: 600;">
                        {% if user.full_name %}
                            {{ user.full_name }}
                        {% else %}
                            {{ user.username }}
                        {% endif %}
                    </div>
                    <div style="font-size: 12px; color: #999;">{{ user.get_level_title|default:"Level 1 Predictor" }}</div>
                </div>
                {% endif %}
                <div class="profile-dropdown" id="profileDropdown">
                    {% if user.is_authenticated %}
                        <a href="{% url 'logout' %}" class="dropdown-item">üö™ Logout</a>
                    {% else %}
                        <a href="{% url 'login' %}" class="dropdown-item">üîí Login</a>
                        <a href="{% url 'register' %}" class="dropdown-item">üìù Register</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    {% if market.market_type == 'target' %}
        <!-- ============================================
             PRICE TARGET MARKET INTERFACE (YES/NO)
        ============================================ -->
        <div class="target-market-container">
            <div id="messages-container">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="target-header">
                <div class="target-badge">üéØ PRICE TARGET PREDICTION</div>
                <h1 class="target-title">{{ market.title }}</h1>
                
                <div class="target-stats-grid">
                    <div class="target-stat-card">
                        <div class="target-stat-label">Current Price</div>
                        <div class="target-stat-value" id="currentPrice">
                            ${{ market.round_start_price|floatformat:0|default:"67,432" }}
                        </div>
                    </div>
                    <div class="target-stat-card">
                        <div class="target-stat-label">Target Price</div>
                        <div class="target-stat-value highlight">
                            ${{ market.target_price|floatformat:0 }}
                        </div>
                    </div>
                    <div class="target-stat-card">
                        <div class="target-stat-label">Highest Reached</div>
                        <div class="target-stat-value" id="highestPrice">
                            ${{ market.highest_price_reached|floatformat:0|default:"67,432" }}
                        </div>
                    </div>
                    <div class="target-stat-card">
                        <div class="target-stat-label">Total Pool</div>
                        <div class="target-stat-value">
                            ${{ market.total_volume|floatformat:0|default:"0" }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="target-progress-section">
                <div class="progress-header">
                    <div class="progress-title">Time Remaining</div>
                    <div class="countdown-timer" id="countdown">
                        Loading...
                    </div>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%;">
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
                
                <div class="progress-info">
                    <span>Started: {{ market.round_start_time|date:"M d, Y" }}</span>
                    <span>Deadline: {{ market.resolution_date|date:"M d, Y H:i" }}</span>
                </div>
            </div>

            <div class="betting-section">
                <h2 class="betting-title">Place Your Prediction</h2>
                
                <div class="yes-no-options">
                    <div class="yn-option yes" id="yesOption" onclick="selectPrediction('YES')">
                        <div class="yn-label">YES ‚úì</div>
                        <div class="yn-odds">{{ market.up_odds|floatformat:2|default:"2.00" }}x</div>
                        <div class="yn-pool-info">
                            {{ market.up_volume|div:market.total_volume|mul:100|floatformat:1|default:"50.0" }}% of pool
                        </div>
                    </div>
                    
                    <div class="yn-option no" id="noOption" onclick="selectPrediction('NO')">
                        <div class="yn-label">NO ‚úó</div>
                        <div class="yn-odds">{{ market.down_odds|floatformat:2|default:"2.00" }}x</div>
                        <div class="yn-pool-info">
                            {{ market.down_volume|div:market.total_volume|mul:100|floatformat:1|default:"50.0" }}% of pool
                        </div>
                    </div>
                </div>

                <div class="bet-amount-section">
                    {% if user.is_authenticated %}
                        <div class="balance-display">
                            Your Balance: <span class="balance-amount">${{ user_balance|floatformat:2|default:"0.00" }}</span>
                        </div>
                    {% endif %}

                    <input type="number" 
                           class="bet-input" 
                           id="betAmount" 
                           placeholder="Enter bet amount ($)" 
                           value="25"
                           min="1"
                           max="10000">
                    
                    <div class="bet-presets">
                        <button class="preset-btn" onclick="setTargetBetAmount(10)">$10</button>
                        <button class="preset-btn active" onclick="setTargetBetAmount(25)">$25</button>
                        <button class="preset-btn" onclick="setTargetBetAmount(50)">$50</button>
                        <button class="preset-btn" onclick="setTargetBetAmount(100)">$100</button>
                    </div>

                    <button class="place-bet-btn" id="placeBetBtn" onclick="placeTargetBet()">
                        {% if user.is_authenticated %}
                            Select YES or NO to Bet
                        {% else %}
                            Login to Place Bet
                        {% endif %}
                    </button>
                </div>
            </div>

            <div class="market-description">
                <div class="description-title">üìã Market Details</div>
                <div class="description-content">{{ market.description|default:"No description available." }}</div>
            </div>
        </div>

        <script>
            const marketId = "{{ market.id }}";
            const csrfToken = "{{ csrf_token }}";
            const resolutionDate = new Date("{{ market.resolution_date|date:'Y-m-d H:i:s' }}");
            const targetPrice = parseFloat("{{ market.target_price|default:'0' }}");
            let selectedPrediction = null;

            // Countdown timer
            function updateCountdown() {
                const now = new Date();
                const diff = resolutionDate - now;
                
                if (diff <= 0) {
                    document.getElementById('countdown').textContent = "Market Closed";
                    document.getElementById('placeBetBtn').disabled = true;
                    document.getElementById('placeBetBtn').textContent = "Market Has Ended";
                    return;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                let countdownText = '';
                if (days > 0) countdownText += `${days}d `;
                countdownText += `${hours}h ${minutes}m ${seconds}s`;
                
                document.getElementById('countdown').textContent = countdownText;
                
                // Update progress bar
                const startDate = new Date("{{ market.round_start_time|date:'Y-m-d H:i:s' }}");
                const totalTime = resolutionDate - startDate;
                const elapsed = now - startDate;
                const progress = Math.min((elapsed / totalTime) * 100, 100);
                
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
            }

            function selectPrediction(prediction) {
                selectedPrediction = prediction;
                
                // Remove selected class from both
                document.getElementById('yesOption').classList.remove('selected');
                document.getElementById('noOption').classList.remove('selected');
                
                // Add selected to chosen option
                if (prediction === 'YES') {
                    document.getElementById('yesOption').classList.add('selected');
                } else {
                    document.getElementById('noOption').classList.add('selected');
                }
                
                updateBetButton();
            }

            function setTargetBetAmount(amount) {
                document.getElementById('betAmount').value = amount;
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                updateBetButton();
            }

            function updateBetButton() {
                const btn = document.getElementById('placeBetBtn');
                const amount = parseFloat(document.getElementById('betAmount').value) || 0;
                
                {% if user.is_authenticated %}
                if (selectedPrediction && amount > 0) {
                    btn.textContent = `Bet $${amount} - ${selectedPrediction}`;
                    btn.disabled = false;
                } else {
                    btn.textContent = 'Select YES or NO to Bet';
                    btn.disabled = true;
                }
                {% else %}
                btn.textContent = 'Login to Place Bet';
                btn.disabled = true;
                btn.onclick = function() { window.location.href = "{% url 'login' %}"; };
                {% endif %}
            }

            async function placeTargetBet() {
                {% if user.is_authenticated %}
                if (!selectedPrediction) {
                    showMessage('Please select YES or NO first', 'error');
                    return;
                }
                
                const amount = parseFloat(document.getElementById('betAmount').value);
                if (!amount || amount < 1) {
                    showMessage('Please enter a valid bet amount', 'error');
                    return;
                }

                const btn = document.getElementById('placeBetBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Placing Bet...';
                btn.disabled = true;
                
                try {
                    const response = await fetch('{% url "place-target-bet" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({
                            market_id: marketId,
                            prediction: selectedPrediction,
                            amount: amount
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showMessage(data.message, 'success');
                        
                        // Update balance
                        const balanceElement = document.querySelector('.balance-amount');
                        if (balanceElement) {
                            balanceElement.textContent = `$${data.new_balance.toFixed(2)}`;
                        }
                        
                        // Reset selection
                        selectedPrediction = null;
                        document.getElementById('yesOption').classList.remove('selected');
                        document.getElementById('noOption').classList.remove('selected');
                        
                        // Reload page to show updated pool
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage(data.error, 'error');
                    }
                } catch (error) {
                    showMessage('Error placing bet. Please try again.', 'error');
                    console.error('Bet error:', error);
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
                {% else %}
                window.location.href = "{% url 'login' %}";
                {% endif %}
            }

            function showMessage(message, type) {
                const container = document.getElementById('messages-container');
                const messageDiv = document.createElement('div');
                messageDiv.className = `alert alert-${type}`;
                messageDiv.textContent = message;
                
                container.innerHTML = '';
                container.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    setTimeout(() => messageDiv.remove(), 300);
                }, 5000);
            }

            // Update every second
            setInterval(updateCountdown, 1000);
            updateCountdown();

            // Input listener
            document.getElementById('betAmount').addEventListener('input', function() {
                updateBetButton();
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            });

            // Profile dropdown
            function toggleProfileMenu() {
                document.getElementById('profileDropdown').classList.toggle('show');
            }

            document.addEventListener('click', function(event) {
                const profile = document.querySelector('.user-profile');
                const dropdown = document.getElementById('profileDropdown');
                
                if (profile && dropdown && !profile.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Auto-hide messages
            document.addEventListener('DOMContentLoaded', function() {
                const messages = document.querySelectorAll('.alert');
                messages.forEach(message => {
                    setTimeout(() => {
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 300);
                    }, 5000);
                });
            });
        </script>

    {% else %}
        <!-- ============================================
             EVENT MARKET INTERFACE (UP/DOWN/FLAT)
             YOUR EXISTING CODE STAYS HERE UNCHANGED
        ============================================ -->
        <div class="container">
            <div class="main-content">
                <div class="event-header">
                    <div class="event-title">
                        <div class="event-icon">
                            {% if 'BTC' in market.title %}‚Çø{% elif 'ETH' in market.title %}Œû{% else %}‚Çø{% endif %}
                        </div>
                        <div>
                            <div class="event-name">{{ market.title|default:"BTC/USDT" }}</div>
                            <div class="event-pair">{{ market.get_round_duration_display|default:"15m" }}</div>
                        </div>
                    </div>
                    <div class="event-description">{{ market.description|default:"Trade on Bitcoin vs USDT price movements with economic events" }}</div>
                    
                    <div class="timeframe-selector">
                        <button class="tf-btn active" data-timeframe="1m" onclick="selectTimeframe('1m')">1m</button>
                        <button class="tf-btn" data-timeframe="3m" onclick="selectTimeframe('3m')">3m</button>
                        <button class="tf-btn" data-timeframe="5m" onclick="selectTimeframe('5m')">5m</button>
                        <button class="tf-btn" data-timeframe="15m" onclick="selectTimeframe('15m')">15m</button>
                    </div>

                    <div class="event-stats">
                        <div class="stat-item">
                            <div class="stat-value">${{ market.total_volume|floatformat:0|default:"105,000" }}</div>
                            <div class="stat-label">Total Pool</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ unique_participants|default:"210" }}</div>
                            <div class="stat-label">Participants</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">CPI</div>
                            <div class="stat-label">Next Event</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">2h 15m</div>
                            <div class="stat-label">Time to Event</div>
                        </div>
                    </div>
                </div>

                <div class="trading-chart">
                    <div class="chart-header">
                        <div class="chart-title">{{ market.trading_pair|default:"BTC/USDT" }} Live Chart</div>
                        <div class="chart-timer" id="roundTimer">{{ round_info.time_remaining|default:"20" }}s</div>
                    </div>
                    <div class="chart-area">
                        <canvas id="marketChart" class="crypto-chart" 
                                data-symbol="{% if 'BTC' in market.title %}BTC{% elif 'ETH' in market.title %}ETH{% else %}BTC{% endif %}"
                                data-market-id="{{ market.id|default:'demo' }}">
                        </canvas>
                        <div class="chart-loading">Loading chart...</div>
                    </div>
                </div>

                <div class="trading-options">
                    <div id="messages-container">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="options-title">Select Your Prediction</div>
                    <div class="option-buttons">
                        <div class="option-btn up" id="upOption" onclick="selectOption('UP')">
                            <div class="option-label up">Closes above</div>
                            <div class="option-change">+{{ market_crypto_data.change_24h|floatformat:2|default:"0.04" }}%</div>
                            <div class="option-stats">
                                <span class="pool-share">Pool share<br>{{ market.up_volume|div:market.total_volume|mul:100|floatformat:1|default:"49.5" }}%</span>
                                <span class="payout">Payout<br>{{ market.up_odds|floatformat:2|default:"2.00" }}x</span>
                            </div>
                        </div>

                        <div class="option-btn flat" id="flatOption" onclick="selectOption('FLAT')">
                            <div class="option-label flat">Stay Flat</div>
                            <div class="option-change">¬±{{ market_crypto_data.change_24h|floatformat:2|default:"0.04" }}%</div>
                            <div class="option-stats">
                                <span class="pool-share">Pool share<br>{{ market.flat_volume|div:market.total_volume|mul:100|floatformat:1|default:"25.2" }}%</span>
                                <span class="payout">Payout<br>{{ market.flat_odds|floatformat:2|default:"2.00" }}x</span>
                            </div>
                        </div>

                        <div class="option-btn down" id="downOption" onclick="selectOption('DOWN')">
                            <div class="option-label down">Closes below</div>
                            <div class="option-change">-{{ market_crypto_data.change_24h|floatformat:2|default:"0.04" }}%</div>
                            <div class="option-stats">
                                <span class="pool-share">Pool share<br>{{ market.down_volume|div:market.total_volume|mul:100|floatformat:1|default:"25.3" }}%</span>
                                <span class="payout">Payout<br>{{ market.down_odds|floatformat:2|default:"1.98" }}x</span>
                            </div>
                        </div>
                    </div>

                    <div class="bet-section">
                        {% if user.is_authenticated %}
                            <div class="balance-info">
                                Your Balance: <span class="balance-amount">${{ user_balance|floatformat:2|default:"0.00" }}</span>
                            </div>
                        {% endif %}
                        
                        <input type="number" 
                               class="bet-amount-input" 
                               id="betAmount" 
                               placeholder="Enter bet amount" 
                               value="25"
                               min="1"
                               max="10000">
                        
                        <div class="bet-presets">
                            <button class="preset-btn" onclick="setBetAmount(10)">$10</button>
                            <button class="preset-btn active" onclick="setBetAmount(25)">$25</button>
                            <button class="preset-btn" onclick="setBetAmount(50)">$50</button>
                            <button class="preset-btn" onclick="setBetAmount(100)">$100</button>
                        </div>

                        <button class="place-bet-btn" id="placeBetBtn" onclick="placeBet()">
                            {% if user.is_authenticated %}
                                Select Option to Bet
                            {% else %}
                                Login to Place Bet
                            {% endif %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar content would go here if needed -->
        </div>

        <script>
            // EVENT MARKET JavaScript (UP/DOWN/FLAT)
            let selectedOption = null;
            const eventMarketId = "{{ market.id|default:'demo' }}";
            const eventCsrfToken = "{{ csrf_token }}";

            function selectOption(option) {
                selectedOption = option;
                
                document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                document.getElementById(option.toLowerCase() + 'Option').classList.add('selected');
                
                updateBetButton();
            }

            function setBetAmount(amount) {
                document.getElementById('betAmount').value = amount;
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                updateBetButton();
            }

            function updateBetButton() {
                const btn = document.getElementById('placeBetBtn');
                const amount = parseFloat(document.getElementById('betAmount').value) || 0;
                
                {% if user.is_authenticated %}
                if (selectedOption && amount > 0) {
                    btn.textContent = `Bet $${amount} - ${selectedOption}`;
                    btn.disabled = false;
                } else {
                    btn.textContent = 'Select Option to Bet';
                    btn.disabled = true;
                }
                {% else %}
                btn.textContent = 'Login to Place Bet';
                btn.disabled = true;
                btn.onclick = function() { window.location.href = "{% url 'login' %}"; };
                {% endif %}
            }

            async function placeBet() {
                {% if user.is_authenticated %}
                if (!selectedOption) {
                    showMessage('Please select an option first', 'error');
                    return;
                }
                
                const amount = parseFloat(document.getElementById('betAmount').value);
                if (!amount || amount < 1) {
                    showMessage('Please enter a valid bet amount', 'error');
                    return;
                }

                const btn = document.getElementById('placeBetBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Placing Bet...';
                btn.disabled = true;
                
                try {
                    const response = await fetch('{% url "place-bet" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': eventCsrfToken,
                        },
                        body: JSON.stringify({
                            market_id: eventMarketId,
                            outcome: selectedOption,
                            amount: amount,
                            bet_type: 'regular'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showMessage(data.message, 'success');
                        
                        const balanceElement = document.querySelector('.balance-amount');
                        if (balanceElement) {
                            balanceElement.textContent = `$${data.new_balance.toFixed(2)}`;
                        }
                        
                        selectedOption = null;
                        document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                        updateBetButton();
                    } else {
                        showMessage(data.error, 'error');
                    }
                } catch (error) {
                    showMessage('Error placing bet. Please try again.', 'error');
                    console.error('Bet error:', error);
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
                {% else %}
                window.location.href = "{% url 'login' %}";
                {% endif %}
            }

            function showMessage(message, type) {
                const container = document.getElementById('messages-container');
                const messageDiv = document.createElement('div');
                messageDiv.className = `alert alert-${type}`;
                messageDiv.textContent = message;
                
                container.innerHTML = '';
                container.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    setTimeout(() => messageDiv.remove(), 300);
                }, 5000);
            }

            function selectTimeframe(tf) {
                document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-timeframe="${tf}"]`).classList.add('active');
            }

            function toggleProfileMenu() {
                document.getElementById('profileDropdown').classList.toggle('show');
            }

            document.addEventListener('click', function(event) {
                const profile = document.querySelector('.user-profile');
                const dropdown = document.getElementById('profileDropdown');
                
                if (profile && dropdown && !profile.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            document.getElementById('betAmount').addEventListener('input', function() {
                updateBetButton();
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            });

            document.addEventListener('DOMContentLoaded', function() {
                const messages = document.querySelectorAll('.alert');
                messages.forEach(message => {
                    setTimeout(() => {
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 300);
                    }, 5000);
                });
            });
        </script>
    {% endif %}
</body>
</html>