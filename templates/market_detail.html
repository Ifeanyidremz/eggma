{% load math_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ market.title|default:"Event Trading" }} - EVGxchain</title>
    {% load static %}
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(45, 45, 45, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 5px 0; 
        }
        
        .logo img {
            height: 100px;
            width: auto;
            transition: transform 0.3s ease;
        }
        
        .logo:hover img {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-links a {
            color: #ccc;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #f7931a;
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #f7931a 0%, #ffb84d 100%);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 12px;
            transition: background 0.3s ease;
            position: relative;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f7931a 0%, #ffb84d 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(45, 45, 45, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            padding: 12px 20px;
            color: #ccc;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f7931a;
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .event-header {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .event-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .event-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f7931a 0%, #ffb84d 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .event-name {
            font-size: 28px;
            font-weight: 700;
        }

        .event-pair {
            color: #666;
            font-size: 16px;
        }

        .event-description {
            color: #888;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tf-btn {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #999;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tf-btn:hover, .tf-btn.active {
            background: rgba(247, 147, 26, 0.2);
            border-color: #f7931a;
            color: #f7931a;
        }

        .event-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .predict-to-earn-widget {
            background: rgba(20, 20, 20, 0.95);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            position: relative;
        }

        .predict-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .predict-icon {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .predict-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        .predict-pair {
            font-size: 12px;
            color: #888;
        }

        .predict-timer-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .predict-timer-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(#8b5cf6 0deg, #8b5cf6 90deg, rgba(255,255,255,0.1) 90deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        .predict-timer-label {
            font-size: 12px;
            color: #888;
        }

        .predict-timeframes {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .predict-tf-btn {
            flex: 1;
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #999;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .predict-tf-btn.active,
        .predict-tf-btn:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .predict-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .predict-options.locked {
            opacity: 0.4;
            pointer-events: none;
        }

        .predict-option {
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .predict-option.up {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .predict-option.up:hover,
        .predict-option.up.selected {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .predict-option.flat {
            border-color: rgba(249, 115, 22, 0.3);
        }

        .predict-option.flat:hover,
        .predict-option.flat.selected {
            background: rgba(249, 115, 22, 0.1);
            border-color: #f97316;
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
        }

        .predict-option.down {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .predict-option.down:hover,
        .predict-option.down.selected {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .predict-option-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .predict-option.up .predict-option-label {
            color: #22c55e;
        }

        .predict-option.flat .predict-option-label {
            color: #f97316;
        }

        .predict-option.down .predict-option-label {
            color: #ef4444;
        }

        .predict-multiplier {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .quick-bet-btn {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .quick-bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .quick-bet-btn:disabled {
            background: rgba(60, 60, 60, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .quick-bet-btn.locked {
            background: rgba(220, 38, 38, 0.8);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .timer-lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 15px;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
            z-index: 10;
        }

        .timer-lock-overlay.active {
            display: flex;
        }

        .lock-message {
            background: rgba(220, 38, 38, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-weight: 600;
        }

        .lock-icon {
            font-size: 24px;
            margin-bottom: 5px;
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .predict-options {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .predict-option {
                padding: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left;
            }
            
            .predict-multiplier {
                font-size: 16px;
            }
        }

        @media (max-width: 768px) {
            .predict-to-earn-widget {
                padding: 15px;
            }
            
            .predict-timer-circle {
                width: 50px;
                height: 50px;
                font-size: 14px;
            }
            
            .predict-timeframes {
                gap: 4px;
            }
            
            .predict-tf-btn {
                padding: 6px;
                font-size: 11px;
            }
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .trading-chart {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 500px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chart-timer {
            background: rgba(30, 30, 30, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            color: #22c55e;
        }

        .chart-area {
            height: 400px;
            background: rgba(10, 10, 10, 0.5);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            padding: 10px;
        }

        .crypto-chart {
            width: 100% !important;
            height: 100% !important;
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }

        .chart-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 12px;
            text-align: center;
        }

        .trading-options {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .options-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .option-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .option-btn {
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .option-btn.up {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .option-btn.up:hover, .option-btn.up.selected {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .option-btn.flat {
            border-color: rgba(249, 115, 22, 0.3);
        }

        .option-btn.flat:hover, .option-btn.flat.selected {
            background: rgba(249, 115, 22, 0.1);
            border-color: #f97316;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.3);
        }

        .option-btn.down {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .option-btn.down:hover, .option-btn.down.selected {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .option-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .option-label.up { color: #22c55e; }
        .option-label.flat { color: #f97316; }
        .option-label.down { color: #ef4444; }

        .option-change {
            font-size: 12px;
            color: #999;
            margin-bottom: 6px;
        }

        .option-stats {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
        }

        .pool-share {
            color: #666;
        }

        .payout {
            color: #f7931a;
            font-weight: 600;
        }

        .bet-section {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .bet-amount-input {
            width: 100%;
            background: rgba(45, 45, 45, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .bet-amount-input:focus {
            outline: none;
            border-color: #f7931a;
        }

        .bet-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .preset-btn {
            background: rgba(45, 45, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #999;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover, .preset-btn.active {
            border-color: #f7931a;
            color: #f7931a;
            background: rgba(247, 147, 26, 0.1);
        }

        .place-bet-btn {
            width: 100%;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .place-bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);
        }

        .place-bet-btn:disabled {
            background: rgba(60, 60, 60, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .current-round-info {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .round-timer {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#22c55e 0deg, #22c55e 270deg, rgba(255,255,255,0.1) 270deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .round-info-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-label {
            color: #999;
        }

        .info-value {
            color: #fff;
            font-weight: 600;
        }

        .user-bets-section {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bet-item {
            background: rgba(30, 30, 30, 0.6);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .bet-item:last-child {
            margin-bottom: 0;
        }

        .bet-outcome {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .bet-outcome.up { color: #22c55e; }
        .bet-outcome.down { color: #ef4444; }
        .bet-outcome.flat { color: #f97316; }

        .bet-details {
            color: #999;
            display: flex;
            justify-content: space-between;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .balance-info {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }

        .balance-amount {
            color: #f7931a;
            font-weight: 600;
            font-size: 16px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .sidebar {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .nav-links {
                display: none;
            }

            .event-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .option-buttons {
                grid-template-columns: 1fr;
            }

            .sidebar {
                grid-template-columns: 1fr;
            }

            .bet-presets {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="{% url 'landing-page' %}" class="logo">
               <img src="/static/evgchain-logo.png" alt="EVGxchain">
            </a>
            <div class="nav-links">
                {% if user.is_authenticated %}
                <a href="{% url 'dashboard' %}">Dashboard</a>
                {% endif %}
            </div>
            <div class="user-profile" onclick="toggleProfileMenu()">
                <div class="user-avatar">
                    {% if user.is_authenticated %}
                        {% if user.full_name %}
                            {{ user.full_name|slice:":2"|upper }}
                        {% else %}
                            {{ user.username|slice:":2"|upper }}
                        {% endif %}
                    {% else %}
                        JD
                    {% endif %}
                </div>
                {% if user.is_authenticated %}
                <div>
                    <div style="font-size: 14px; font-weight: 600;">
                        {% if user.full_name %}
                            {{ user.full_name }}
                        {% else %}
                            {{ user.username }}
                        {% endif %}
                    </div>
                    <div style="font-size: 12px; color: #999;">{{ user.get_level_title|default:"Level 1 Predictor" }}</div>
                </div>
                {% endif %}
                <div class="profile-dropdown" id="profileDropdown">
                    {% if user.is_authenticated %}
                        <a href="{% url 'logout' %}" class="dropdown-item">🚪 Logout</a>
                    {% else %}
                        <a href="{% url 'login' %}" class="dropdown-item">🔒 Login</a>
                        <a href="{% url 'register' %}" class="dropdown-item">📝 Register</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div class="event-header">
                <div class="event-title">
                    <div class="event-icon">
                        {% if 'BTC' in market.title %}₿{% elif 'ETH' in market.title %}Ξ{% else %}₿{% endif %}
                    </div>
                    <div>
                        <div class="event-name">{{ market.title|default:"BTC/USDT" }}</div>
                        <div class="event-pair">{{ market.get_round_duration_display|default:"15m" }}</div>
                    </div>
                </div>
                <div class="event-description">{{ market.description|default:"Trade on Bitcoin vs USDT price movements with economic events: CPI, FOMC, NFP releases" }}</div>
                
                <div class="timeframe-selector">
                    <button class="tf-btn active" data-timeframe="1m" onclick="selectTimeframe('1m')">1m</button>
                    <button class="tf-btn" data-timeframe="3m" onclick="selectTimeframe('3m')">3m</button>
                    <button class="tf-btn" data-timeframe="5m" onclick="selectTimeframe('5m')">5m</button>
                    <button class="tf-btn" data-timeframe="15m" onclick="selectTimeframe('15m')">15m</button>
                </div>

                <div class="event-stats">
                    <div class="stat-item">
                        <div class="stat-value">${{ market.total_volume|floatformat:0|default:"105,000" }}</div>
                        <div class="stat-label">Total Pool</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ unique_participants|default:"210" }}</div>
                        <div class="stat-label">Participants</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">CPI</div>
                        <div class="stat-label">Next Event</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">2h 15m</div>
                        <div class="stat-label">Time to Event</div>
                    </div>
                </div>
            </div>

            <div class="trading-chart">
                <div class="chart-header">
                    <div class="chart-title">{{ market.trading_pair|default:"BTC/USDT" }} Live Chart</div>
                    <div class="chart-timer" id="roundTimer">{{ round_info.time_remaining|default:"20" }}s</div>
                </div>
                <div class="chart-area">
                    <canvas id="marketChart" class="crypto-chart" 
                            data-symbol="{% if 'BTC' in market.title %}BTC{% elif 'ETH' in market.title %}ETH{% else %}BTC{% endif %}"
                            data-market-id="{{ market.id|default:'demo' }}">
                    </canvas>
                    <div class="chart-loading">Loading chart...</div>
                </div>
            </div>

            <div class="trading-options">
                <div id="messages-container">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="options-title">Select Your Prediction</div>
                <div class="option-buttons">
                    <div class="option-btn up" id="upOption" onclick="selectOption('UP')">
                        <div class="option-label up">Closes above</div>
                        <div class="option-change">+{{ market_crypto_data.change_24h|floatformat:2|default:"0.04" }}%</div>
                        <div class="option-stats">
                            <span class="pool-share">Pool share<br>{{ market.up_volume|div:market.total_volume|mul:100|floatformat:1|default:"49.5" }}%</span>
                            <span class="payout">Payout<br>{{ market.up_odds|floatformat:2|default:"2.00" }}x</span>
                        </div>
                    </div>

                    <div class="option-btn flat" id="flatOption" onclick="selectOption('FLAT')">
                        <div class="option-label flat">Stay Flat</div>
                        <div class="option-change">±{{ market_crypto_data.change_24h|floatformat:2|default:"0.04" }}%</div>
                        <div class="option-stats">
                            <span class="pool-share">Pool share<br>{{ market.flat_volume|div:market.total_volume|mul:100|floatformat:1|default:"25.2" }}%</span>
                            <span class="payout">Payout<br>{{ market.flat_odds|floatformat:2|default:"2.00" }}x</span>
                        </div>
                    </div>

                    <div class="option-btn down" id="downOption" onclick="selectOption('DOWN')">
                        <div class="option-label down">Closes below</div>
                        <div class="option-change">-{{ market_crypto_data.change_24h|floatformat:2|default:"0.04" }}%</div>
                        <div class="option-stats">
                            <span class="pool-share">Pool share<br>{{ market.down_volume|div:market.total_volume|mul:100|floatformat:1|default:"25.3" }}%</span>
                            <span class="payout">Payout<br>{{ market.down_odds|floatformat:2|default:"1.98" }}x</span>
                        </div>
                    </div>
                </div>

                <div class="bet-section">
                    {% if user.is_authenticated %}
                        <div class="balance-info">
                            Your Balance: <span class="balance-amount">${{ user_balance|floatformat:2|default:"0.00" }}</span>
                        </div>
                    {% endif %}
                    
                    <input type="number" 
                           class="bet-amount-input" 
                           id="betAmount" 
                           placeholder="Enter bet amount" 
                           value="25"
                           min="{{ market.min_bet|default:'1' }}"
                           max="{{ market.max_bet|default:'10000' }}">
                    
                    <div class="bet-presets">
                        <button class="preset-btn" onclick="setBetAmount(10)">$10</button>
                        <button class="preset-btn active" onclick="setBetAmount(25)">$25</button>
                        <button class="preset-btn" onclick="setBetAmount(50)">$50</button>
                        <button class="preset-btn" onclick="setBetAmount(100)">$100</button>
                    </div>

                    <button class="place-bet-btn" id="placeBetBtn" onclick="placeBet()">
                        {% if user.is_authenticated %}
                            Select Option to Bet
                        {% else %}
                            Login to Place Bet
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="predict-to-earn-widget">
                <!-- Timer Lock Overlay -->
                <div class="timer-lock-overlay" id="timerLockOverlay">
                    <div class="lock-message">
                        <span class="lock-icon">🔒</span>
                        <div>Betting Locked</div>
                        <div style="font-size: 12px; margin-top: 5px;">Wait for next round</div>
                    </div>
                </div>

                <div class="predict-header">
                    <div class="predict-icon">⚡</div>
                    <div class="predict-title">
                        <div class="predict-name">Predict to Earn</div>
                        <div class="predict-pair">BTC/ETH</div>
                    </div>
                </div>
                
                <div class="predict-timer-section">
                    <div class="predict-timer-circle" id="predictTimer">4s</div>
                    <div class="predict-timer-label">Round Ends</div>
                </div>
                
                <div class="predict-timeframes">
                    <button class="predict-tf-btn active" data-predict-tf="1m" onclick="selectPredictTimeframe('1m')">1m</button>
                    <button class="predict-tf-btn" data-predict-tf="2m" onclick="selectPredictTimeframe('2m')">2m</button>
                    <button class="predict-tf-btn" data-predict-tf="3m" onclick="selectPredictTimeframe('3m')">3m</button>
                </div>
                
                <div class="predict-options" id="predictOptions">
                    <div class="predict-option up" id="predictUpOption" onclick="selectPredictOption('UP')">
                        <div class="predict-option-label">UP</div>
                        <div class="predict-multiplier">1.95x</div>
                    </div>
                    <div class="predict-option flat" id="predictFlatOption" onclick="selectPredictOption('FLAT')">
                        <div class="predict-option-label">FLAT</div>
                        <div class="predict-multiplier">3.20x</div>
                    </div>
                    <div class="predict-option down" id="predictDownOption" onclick="selectPredictOption('DOWN')">
                        <div class="predict-option-label">DOWN</div>
                        <div class="predict-multiplier">1.98x</div>
                    </div>
                </div>
                
                <button class="quick-bet-btn" id="quickBetBtn" onclick="placeQuickBet()">
                    Quick Bet - $1
                </button>
            </div>

            <div class="current-round-info">
                <div class="round-timer">
                    <div class="timer-circle" id="timerCircle">{{ round_info.time_remaining|default:"20" }}s</div>
                    <div style="font-size: 14px; color: #999;">Current Round Info</div>
                </div>

                <div class="round-info-title">Round Details</div>
                <div class="info-row">
                    <span class="info-label">Total pool outcome:</span>
                    <span class="info-value">${{ market.total_volume|floatformat:0|default:"105,000" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"># of participants in current round:</span>
                    <span class="info-value">{{ unique_participants|default:"210" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Round Duration:</span>
                    <span class="info-value">{{ market.get_round_duration_display|default:"15 minutes" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Next Event:</span>
                    <span class="info-value">CPI Release</span>
                </div>
                {% if market_crypto_data %}
                <div class="info-row">
                    <span class="info-label">Current Price:</span>
                    <span class="info-value">${{ market_crypto_data.price|floatformat:2 }}</span>
                </div>
                {% endif %}
            </div>

            {% if user.is_authenticated and user_bets %}
            <div class="user-bets-section">
                <div class="round-info-title">Your Active Bets</div>
                {% for bet in user_bets|slice:":5" %}
                <div class="bet-item">
                    <div class="bet-outcome {{ bet.outcome|lower }}">{{ bet.get_outcome_display }} - ${{ bet.amount|floatformat:2 }}</div>
                    <div class="bet-details">
                        <span>{{ bet.odds_at_bet|floatformat:2 }}x odds</span>
                        <span>Potential: ${{ bet.potential_payout|floatformat:2 }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        let selectedOption = null;
        let currentTimeframe = '15m';
        let timeRemaining = {{ round_info.time_remaining|default:'20' }};
        const marketId = "{{ market.id|default:'demo' }}";
        const csrfToken = "{{ csrf_token }}";

        // Chart variables
        let chartInstance = null;
        let priceData = [];
        let animationId = null;

        // Predict to Earn variables
        let predictSelectedOption = null;
        let predictTimeframe = '1m';
        let predictTimeRemaining = 65; // Start with 65 seconds so first 5 seconds show timer lock
        let isPredictLocked = true; // Start locked

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing market detail page...');
            initializeChart();
            updateBetButton();
            updateQuickBetButton();
            updatePredictLockStatus();
            
            // Start update intervals
            setInterval(updateTimer, 1000);
            setInterval(updatePredictTimer, 1000);
            setInterval(updateChartData, 2000); // Update chart every 2 seconds
            setInterval(updateMarketData, 10000); // Update market data every 10 seconds
            
            // Auto-hide messages
            const messages = document.querySelectorAll('.alert');
            messages.forEach(message => {
                setTimeout(() => {
                    message.style.opacity = '0';
                    message.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        message.remove();
                    }, 300);
                }, 5000);
            });
        });

        function updatePredictLockStatus() {
            const lockOverlay = document.getElementById('timerLockOverlay');
            const predictOptions = document.getElementById('predictOptions');
            const quickBetBtn = document.getElementById('quickBetBtn');
            
            if (isPredictLocked) {
                lockOverlay.classList.add('active');
                predictOptions.classList.add('locked');
                quickBetBtn.classList.add('locked');
                quickBetBtn.disabled = true;
                quickBetBtn.textContent = 'Betting Locked - Wait for next round';
            } else {
                lockOverlay.classList.remove('active');
                predictOptions.classList.remove('locked');
                quickBetBtn.classList.remove('locked');
                quickBetBtn.disabled = false;
                updateQuickBetButton();
            }
        }

        function updatePredictTimer() {
            const timerEl = document.getElementById('predictTimer');
            const circleEl = document.getElementById('predictTimer');
            
            if (predictTimeRemaining <= 0) {
                // Reset timer based on timeframe
                if (predictTimeframe === '1m') predictTimeRemaining = 60;
                else if (predictTimeframe === '2m') predictTimeRemaining = 120;
                else if (predictTimeframe === '3m') predictTimeRemaining = 180;
            }
            
            // Check if we're in the lock period (last 20 seconds)
            const wasLocked = isPredictLocked;
            isPredictLocked = predictTimeRemaining <= 20;
            
            // Update lock status if it changed
            if (wasLocked !== isPredictLocked) {
                updatePredictLockStatus();
                
                if (!isPredictLocked) {
                    // Just unlocked - show success message
                    showMessage('Predict to Earn: Betting is now open!', 'success');
                } else if (isPredictLocked && !wasLocked) {
                    // Just locked - show warning message  
                    showMessage('Predict to Earn: Betting locked - preparing for round close', 'error');
                }
            }
            
            const displayTime = predictTimeRemaining < 60 ? 
                `${predictTimeRemaining}s` : 
                `${Math.floor(predictTimeRemaining / 60)}m ${predictTimeRemaining % 60}s`;
            
            timerEl.textContent = displayTime;
            
            // Update circle progress and color
            const maxTime = predictTimeframe === '1m' ? 60 : 
                           predictTimeframe === '2m' ? 120 : 180;
            const percentage = (predictTimeRemaining / maxTime) * 360;
            
            // Color changes based on lock status
            let color;
            if (isPredictLocked) {
                color = '#ef4444'; // Red when locked
            } else if (predictTimeRemaining < 30) {
                color = '#f97316'; // Orange when approaching lock
            } else {
                color = '#8b5cf6'; // Purple when safe to bet
            }
            
            circleEl.style.background = 
                `conic-gradient(${color} 0deg, ${color} ${percentage}deg, rgba(255,255,255,0.1) ${percentage}deg)`;
            
            predictTimeRemaining--;
        }

        function selectPredictTimeframe(tf) {
            if (isPredictLocked) {
                showMessage('Cannot change timeframe during betting lock period', 'error');
                return;
            }
            
            predictTimeframe = tf;
            document.querySelectorAll('.predict-tf-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-predict-tf="${tf}"]`).classList.add('active');
            
            // Reset timer based on timeframe
            if (tf === '1m') predictTimeRemaining = 60;
            else if (tf === '2m') predictTimeRemaining = 120;
            else if (tf === '3m') predictTimeRemaining = 180;
            
            isPredictLocked = predictTimeRemaining <= 20;
            updatePredictLockStatus();
        }

        function selectPredictOption(option) {
            if (isPredictLocked) {
                showMessage('Betting is locked - wait for next round', 'error');
                return;
            }
            
            predictSelectedOption = option;
            
            document.querySelectorAll('.predict-option').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('predict' + option.charAt(0) + option.slice(1).toLowerCase() + 'Option').classList.add('selected');
            
            updateQuickBetButton();
        }

        function updateQuickBetButton() {
            const btn = document.getElementById('quickBetBtn');
            
            if (isPredictLocked) {
                btn.textContent = 'Betting Locked - Wait for next round';
                btn.disabled = true;
                btn.classList.add('locked');
                return;
            }
            
            {% if user.is_authenticated %}
            if (predictSelectedOption) {
                btn.textContent = `Quick Bet $1 - ${predictSelectedOption}`;
                btn.disabled = false;
                btn.classList.remove('locked');
                
                // Change button color based on selection
                if (predictSelectedOption === 'UP') {
                    btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                } else if (predictSelectedOption === 'FLAT') {
                    btn.style.background = 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)';
                } else if (predictSelectedOption === 'DOWN') {
                    btn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                }
            } else {
                btn.textContent = 'Quick Bet - $1';
                btn.disabled = false;
                btn.classList.remove('locked');
                btn.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
            }
            {% else %}
            btn.textContent = 'Login to Quick Bet';
            btn.disabled = true;
            btn.onclick = function() { window.location.href = "{% url 'login' %}"; };
            {% endif %}
        }

        async function placeQuickBet() {
            if (isPredictLocked) {
                showMessage('Betting is locked - please wait for next round', 'error');
                return;
            }
            
            {% if user.is_authenticated %}
            if (!predictSelectedOption) {
                showMessage('Please select UP, FLAT, or DOWN first', 'error');
                return;
            }
            
            const btn = document.getElementById('quickBetBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Placing...';
            btn.disabled = true;
            
            try {
                const response = await fetch('{% url "place-bet" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        market_id: marketId,
                        outcome: predictSelectedOption,
                        amount: 1,
                        bet_type: 'quick_predict',
                        timeframe: predictTimeframe
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Quick bet placed: ${predictSelectedOption} $1`, 'success');
                    
                    // Update balance display
                    const balanceElement = document.querySelector('.balance-amount');
                    if (balanceElement) {
                        balanceElement.textContent = `${data.new_balance.toFixed(2)}`;
                    }
                    
                    // Reset selection after successful bet
                    predictSelectedOption = null;
                    document.querySelectorAll('.predict-option').forEach(btn => btn.classList.remove('selected'));
                } else {
                    showMessage(data.error || 'Failed to place quick bet', 'error');
                }
            } catch (error) {
                showMessage('Error placing quick bet. Please try again.', 'error');
                console.error('Quick bet error:', error);
            }
            
            btn.textContent = originalText;
            updateQuickBetButton();
            {% else %}
            window.location.href = "{% url 'login' %}";
            {% endif %}
        }

        function initializeChart() {
            const canvas = document.getElementById('marketChart');
            if (!canvas) return;
            
            const symbol = canvas.dataset.symbol || 'BTC';
            
            try {
                // Initialize price data
                generateInitialPriceData(symbol);
                
                // Draw initial chart
                drawCandlestickChart(canvas, symbol);
                
                // Hide loading indicator
                const loadingEl = canvas.parentElement.querySelector('.chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
                
                console.log(`Chart initialized for ${symbol}`);
                
            } catch (error) {
                console.error('Error initializing chart:', error);
                showChartError(canvas, 'Chart initialization failed');
            }
        }

        function generateInitialPriceData(symbol) {
            const basePrice = symbol === 'BTC' ? 67432 : symbol === 'ETH' ? 3421 : 67432;
            const points = 100;
            priceData = [];
            
            let currentPrice = basePrice;
            
            for (let i = 0; i < points; i++) {
                // Generate realistic OHLC data
                const variation = (Math.random() - 0.5) * 0.02; // ±1% max variation
                const open = currentPrice;
                const volatility = basePrice * 0.001; // 0.1% volatility
                
                const high = open + Math.random() * volatility;
                const low = open - Math.random() * volatility;
                const close = open + (variation * basePrice * 0.5);
                
                priceData.push({
                    timestamp: Date.now() - ((points - i) * 60000), // 1 minute intervals
                    open: Math.max(low, open),
                    high: Math.max(high, Math.max(open, close)),
                    low: Math.min(low, Math.min(open, close)),
                    close: close,
                    volume: Math.random() * 1000000
                });
                
                currentPrice = close;
            }
        }

        function drawCandlestickChart(canvas, symbol) {
            if (!canvas || !priceData.length) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            // Set canvas size
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            const width = rect.width;
            const height = rect.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Calculate price range
            const prices = priceData.map(d => [d.high, d.low]).flat();
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice;
            
            const padding = 40;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            // Draw grid lines
            drawGrid(ctx, padding, chartWidth, chartHeight, minPrice, maxPrice);
            
            // Draw candlesticks
            const candleWidth = Math.max(2, chartWidth / priceData.length * 0.8);
            const candleSpacing = chartWidth / priceData.length;
            
            priceData.forEach((candle, index) => {
                const x = padding + (index * candleSpacing) + (candleSpacing / 2);
                
                const openY = padding + ((maxPrice - candle.open) / priceRange) * chartHeight;
                const closeY = padding + ((maxPrice - candle.close) / priceRange) * chartHeight;
                const highY = padding + ((maxPrice - candle.high) / priceRange) * chartHeight;
                const lowY = padding + ((maxPrice - candle.low) / priceRange) * chartHeight;
                
                const isGreen = candle.close > candle.open;
                const color = isGreen ? '#22c55e' : '#ef4444';
                
                // Draw wick
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // Draw body
                ctx.fillStyle = color;
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                
                const bodyHeight = Math.abs(closeY - openY);
                const bodyY = Math.min(openY, closeY);
                
                if (bodyHeight < 1) {
                    // Doji - draw line
                    ctx.beginPath();
                    ctx.moveTo(x - candleWidth/2, openY);
                    ctx.lineTo(x + candleWidth/2, openY);
                    ctx.stroke();
                } else {
                    if (isGreen) {
                        ctx.fillRect(x - candleWidth/2, bodyY, candleWidth, bodyHeight);
                    } else {
                        ctx.strokeRect(x - candleWidth/2, bodyY, candleWidth, bodyHeight);
                    }
                }
            });
            
            // Draw current price line
            if (priceData.length > 0) {
                const currentPrice = priceData[priceData.length - 1].close;
                const priceY = padding + ((maxPrice - currentPrice) / priceRange) * chartHeight;
                
                ctx.strokeStyle = symbol === 'BTC' ? '#f7931a' : '#627eea';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                
                ctx.beginPath();
                ctx.moveTo(padding, priceY);
                ctx.lineTo(width - padding, priceY);
                ctx.stroke();
                
                ctx.setLineDash([]);
                
                // Price label
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(width - padding - 80, priceY - 10, 75, 20);
                
                ctx.fillStyle = 'white';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${currentPrice.toLocaleString(undefined, {maximumFractionDigits: 0})}`, width - padding - 5, priceY + 4);
            }
        }

        function drawGrid(ctx, padding, chartWidth, chartHeight, minPrice, maxPrice) {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines (price levels)
            const gridLines = 5;
            for (let i = 0; i <= gridLines; i++) {
                const y = padding + (i / gridLines) * chartHeight;
                const price = maxPrice - (i / gridLines) * (maxPrice - minPrice);
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
                
                // Price labels
                ctx.fillStyle = '#666';
                ctx.font = '10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`${price.toLocaleString(undefined, {maximumFractionDigits: 0})}`, padding + 5, y - 2);
            }
            
            // Vertical grid lines (time)
            const timeLines = 6;
            for (let i = 0; i <= timeLines; i++) {
                const x = padding + (i / timeLines) * chartWidth;
                
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + chartHeight);
                ctx.stroke();
            }
        }

        function updateChartData() {
            if (!priceData.length) return;
            
            // Add new candle data
            const lastCandle = priceData[priceData.length - 1];
            const variation = (Math.random() - 0.5) * 0.01; // ±0.5% variation
            const basePrice = lastCandle.close;
            const volatility = basePrice * 0.002;
            
            const newCandle = {
                timestamp: Date.now(),
                open: lastCandle.close,
                high: lastCandle.close + Math.random() * volatility,
                low: lastCandle.close - Math.random() * volatility,
                close: lastCandle.close + (variation * basePrice),
                volume: Math.random() * 1000000
            };
            
            // Ensure OHLC consistency
            newCandle.high = Math.max(newCandle.high, Math.max(newCandle.open, newCandle.close));
            newCandle.low = Math.min(newCandle.low, Math.min(newCandle.open, newCandle.close));
            
            priceData.push(newCandle);
            
            // Keep only last 100 candles
            if (priceData.length > 100) {
                priceData.shift();
            }
            
            // Redraw chart
            const canvas = document.getElementById('marketChart');
            if (canvas) {
                const symbol = canvas.dataset.symbol || 'BTC';
                drawCandlestickChart(canvas, symbol);
            }
        }

        function showChartError(canvas, message) {
            if (!canvas) return;
            
            const chartArea = canvas.parentElement;
            let errorEl = chartArea.querySelector('.chart-error');
            
            if (!errorEl) {
                errorEl = document.createElement('div');
                errorEl.className = 'chart-error';
                chartArea.appendChild(errorEl);
            }
            
            errorEl.textContent = message;
            
            // Hide loading indicator
            const loadingEl = chartArea.querySelector('.chart-loading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }

        // Profile dropdown functionality
        function toggleProfileMenu() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profile = document.querySelector('.user-profile');
            const dropdown = document.getElementById('profileDropdown');
            
            if (!profile.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function selectTimeframe(tf) {
            currentTimeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-timeframe="${tf}"]`).classList.add('active');
            
            // Update event pair display
            document.querySelector('.event-pair').textContent = tf;
            
            // Reset timer based on timeframe
            if (tf === '1m') timeRemaining = 60;
            else if (tf === '3m') timeRemaining = 180;
            else if (tf === '5m') timeRemaining = 300;
            else if (tf === '15m') timeRemaining = 900;
            
            // Regenerate chart data for new timeframe
            const canvas = document.getElementById('marketChart');
            if (canvas) {
                const symbol = canvas.dataset.symbol || 'BTC';
                generateInitialPriceData(symbol);
                drawCandlestickChart(canvas, symbol);
            }
        }

        function selectOption(option) {
            selectedOption = option;
            
            document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(option.toLowerCase() + 'Option').classList.add('selected');
            
            updateBetButton();
        }

        function setBetAmount(amount) {
            document.getElementById('betAmount').value = amount;
            
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateBetButton();
        }

        function updateBetButton() {
            const btn = document.getElementById('placeBetBtn');
            const amount = parseFloat(document.getElementById('betAmount').value) || 0;
            
            {% if user.is_authenticated %}
            if (selectedOption && amount > 0) {
                btn.textContent = `Bet ${amount} - ${selectedOption}`;
                btn.disabled = false;
                btn.style.background = selectedOption === 'UP' ? 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)' :
                                    selectedOption === 'FLAT' ? 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)' :
                                    'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else {
                btn.textContent = 'Select Option to Bet';
                btn.disabled = true;
                btn.style.background = 'rgba(60, 60, 60, 0.5)';
            }
            {% else %}
            btn.textContent = 'Login to Place Bet';
            btn.disabled = true;
            btn.onclick = function() { window.location.href = "{% url 'login' %}"; };
            {% endif %}
        }

        async function placeBet() {
            {% if user.is_authenticated %}
            if (!selectedOption) {
                showMessage('Please select an option first', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('betAmount').value);
            if (!amount || amount < 1) {
                showMessage('Please enter a valid bet amount', 'error');
                return;
            }

            const btn = document.getElementById('placeBetBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Placing Bet...';
            btn.disabled = true;
            
            try {
                const response = await fetch('{% url "place-bet" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        market_id: marketId,
                        outcome: selectedOption,
                        amount: amount,
                        bet_type: 'regular'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    
                    // Update balance display
                    const balanceElement = document.querySelector('.balance-amount');
                    if (balanceElement) {
                        balanceElement.textContent = `${data.new_balance.toFixed(2)}`;
                    }
                    
                    // Reset selection
                    selectedOption = null;
                    document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                    updateBetButton();
                    
                    // Refresh market data
                    await updateMarketData();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('Error placing bet. Please try again.', 'error');
                console.error('Bet error:', error);
            }
            
            btn.textContent = originalText;
            btn.disabled = false;
            {% else %}
            window.location.href = "{% url 'login' %}";
            {% endif %}
        }

        function showMessage(message, type) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = message;
            
            // Clear existing messages
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    messageDiv.remove();
                }, 300);
            }, 5000);
        }

        async function updateMarketData() {
            try {
                const response = await fetch(`/api/market/${marketId}/`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update pool volumes and odds
                    updatePoolStats(data);
                    
                    // Update participant count
                    const participantElements = document.querySelectorAll('.info-value');
                    if (participantElements[1]) {
                        participantElements[1].textContent = data.participants;
                    }
                }
            } catch (error) {
                console.log('Could not fetch market data:', error);
            }
        }

        function updatePoolStats(data) {
            const options = document.querySelectorAll('.option-btn');
            
            // Update UP option
            const upShare = (data.up_volume / data.total_volume * 100).toFixed(1);
            options[0].querySelector('.pool-share').innerHTML = `Pool share<br>${upShare}%`;
            options[0].querySelector('.payout').innerHTML = `Payout<br>${data.up_odds.toFixed(2)}x`;
            
            // Update FLAT option
            const flatShare = (data.flat_volume / data.total_volume * 100).toFixed(1);
            options[1].querySelector('.pool-share').innerHTML = `Pool share<br>${flatShare}%`;
            options[1].querySelector('.payout').innerHTML = `Payout<br>${data.flat_odds.toFixed(2)}x`;
            
            // Update DOWN option
            const downShare = (data.down_volume / data.total_volume * 100).toFixed(1);
            options[2].querySelector('.pool-share').innerHTML = `Pool share<br>${downShare}%`;
            options[2].querySelector('.payout').innerHTML = `Payout<br>${data.down_odds.toFixed(2)}x`;
            
            // Update total pool
            document.querySelector('.stat-value').textContent = `${data.total_volume.toLocaleString()}`;
            const infoValues = document.querySelectorAll('.info-value');
            if (infoValues[0]) {
                infoValues[0].textContent = `${data.total_volume.toLocaleString()}`;
            }
        }

        function updateTimer() {
            timeRemaining--;
            
            if (timeRemaining <= 0) {
                // Reset timer based on timeframe
                if (currentTimeframe === '1m') timeRemaining = 60;
                else if (currentTimeframe === '3m') timeRemaining = 180;
                else if (currentTimeframe === '5m') timeRemaining = 300;
                else if (currentTimeframe === '15m') timeRemaining = 900;
            }
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            
            document.getElementById('roundTimer').textContent = display;
            document.getElementById('timerCircle').textContent = display;
            
            // Update timer circle gradient
            const maxTime = currentTimeframe === '1m' ? 60 : 
                           currentTimeframe === '3m' ? 180 : 
                           currentTimeframe === '5m' ? 300 : 900;
            const percentage = (timeRemaining / maxTime) * 360;
            const color = timeRemaining < 60 ? '#ef4444' : '#22c55e';
            document.getElementById('timerCircle').style.background = 
                `conic-gradient(${color} 0deg, ${color} ${percentage}deg, rgba(255,255,255,0.1) ${percentage}deg)`;
        }

        // Add input listener for bet amount
        document.getElementById('betAmount').addEventListener('input', function() {
            updateBetButton();
            // Clear preset selection
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
        });

        // Add some visual effects for price changes
        setInterval(() => {
            if (Math.random() < 0.3) {
                const priceChange = (Math.random() - 0.5) * 0.1;
                const changeElements = document.querySelectorAll('.option-change');
                changeElements.forEach((el, index) => {
                    const currentChange = parseFloat(el.textContent.replace(/[%+\-±]/g, ''));
                    const newChange = (currentChange + priceChange).toFixed(2);
                    
                    if (index === 0) { // Up option
                        el.textContent = `+${Math.abs(newChange)}%`;
                    } else if (index === 1) { // Flat option  
                        el.textContent = `±${Math.abs(newChange)}%`;
                    } else { // Down option
                        el.textContent = `-${Math.abs(newChange)}%`;
                    }
                });
            }
        }, 2000);

        // Update multipliers periodically for predict to earn
        setInterval(() => {
            if (Math.random() < 0.4) {
                const multipliers = document.querySelectorAll('.predict-multiplier');
                multipliers.forEach((el, index) => {
                    const currentMult = parseFloat(el.textContent.replace('x', ''));
                    const variation = (Math.random() - 0.5) * 0.1;
                    const newMult = Math.max(1.1, currentMult + variation);
                    el.textContent = `${newMult.toFixed(2)}x`;
                });
            }
        }, 3000);
    </script>
</body>
</html>
